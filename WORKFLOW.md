# FolliCore Workflow
## Принцип работы системы

> Полный цикл: от пациента до рекомендации

---

## 1. Обзор системы

### 1.1 Что такое FolliCore

FolliCore — платформа предиктивной трихологии, объединяющая:
- **Computer Vision** — анализ трихоскопических изображений
- **Acoustic Analysis** — акустический анализ структуры волоса
- **POMDP Engine** — принятие решений в условиях неопределённости

### 1.2 Ключевая идея

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                                                                              │
│   👁️ VISION                    🔊 ACOUSTIC                                   │
│   "Что мы ВИДИМ"              "Что мы СЛЫШИМ"                               │
│                                                                              │
│   • Плотность волос           • Пористость кутикулы                         │
│   • Толщина стержня           • Уровень гидратации                          │
│   • Соотношение фаз           • Структурные повреждения                     │
│   • Миниатюризация            • Внутреннее состояние                        │
│                                                                              │
│                        ┌───────────────┐                                    │
│                        │   FUSION      │                                    │
│                        │   60% + 40%   │                                    │
│                        └───────┬───────┘                                    │
│                                │                                             │
│                                ▼                                             │
│                    ┌─────────────────────┐                                  │
│                    │  ПОЛНАЯ КАРТИНА     │                                  │
│                    │  + Cross-validation │                                  │
│                    └─────────────────────┘                                  │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 2. Архитектура системы

### 2.1 Высокоуровневая схема

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         FOLLICORE ARCHITECTURE                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│                              ПАЦИЕНТ                                         │
│                                 │                                            │
│                 ┌───────────────┴───────────────┐                           │
│                 │                               │                            │
│                 ▼                               ▼                            │
│  ┌─────────────────────────┐    ┌─────────────────────────┐                │
│  │      VISION INPUT       │    │     ACOUSTIC INPUT      │                │
│  │  ┌───────────────────┐  │    │  ┌───────────────────┐  │                │
│  │  │  Трихоскоп/       │  │    │  │  Акустический     │  │                │
│  │  │  Дерматоскоп      │  │    │  │  сенсор FolliCore │  │                │
│  │  │  (существующее)   │  │    │  │  (разработка)     │  │                │
│  │  └───────────────────┘  │    │  └───────────────────┘  │                │
│  │           │              │    │           │             │                │
│  │           ▼              │    │           ▼             │                │
│  │  ITrichoscopyImage      │    │  IAcousticRecording     │                │
│  │  (JPEG/PNG, 50-200x)    │    │  (WAV, 48-192kHz)       │                │
│  └─────────────────────────┘    └─────────────────────────┘                │
│                 │                               │                            │
│                 ▼                               ▼                            │
│  ┌─────────────────────────┐    ┌─────────────────────────┐                │
│  │    VISION ANALYZER      │    │    ACOUSTIC ANALYZER    │                │
│  │  ┌───────────────────┐  │    │  ┌───────────────────┐  │                │
│  │  │ DINOv2-Large      │  │    │  │ Wav2Vec2-Conformer│  │                │
│  │  │ (1024-dim embed)  │  │    │  │ (768-dim embed)   │  │                │
│  │  └───────────────────┘  │    │  └───────────────────┘  │                │
│  │  ┌───────────────────┐  │    │  ┌───────────────────┐  │                │
│  │  │ MedSAM            │  │    │  │ Spectral Analysis │  │                │
│  │  │ (Segmentation)    │  │    │  │ (Mel, MFCC)       │  │                │
│  │  └───────────────────┘  │    │  └───────────────────┘  │                │
│  │  ┌───────────────────┐  │    │  ┌───────────────────┐  │                │
│  │  │ Analysis Heads:   │  │    │  │ Analysis Heads:   │  │                │
│  │  │ • Morphometry     │  │    │  │ • Porosity        │  │                │
│  │  │ • Density         │  │    │  │ • Hydration       │  │                │
│  │  │ • Cycle           │  │    │  │ • Structure       │  │                │
│  │  └───────────────────┘  │    │  └───────────────────┘  │                │
│  └─────────────────────────┘    └─────────────────────────┘                │
│                 │                               │                            │
│                 ▼                               ▼                            │
│      ITrichoscopyAnalysis            IAcousticAnalysisResult               │
│                 │                               │                            │
│                 └───────────────┬───────────────┘                           │
│                                 │                                            │
│                                 ▼                                            │
│              ┌─────────────────────────────────────┐                        │
│              │      MULTIMODAL INTEGRATION         │                        │
│              │  ┌───────────────────────────────┐  │                        │
│              │  │  Late Fusion (60/40)          │  │                        │
│              │  │  + Modality Agreement         │  │                        │
│              │  │  + Discrepancy Detection      │  │                        │
│              │  └───────────────────────────────┘  │                        │
│              └─────────────────────────────────────┘                        │
│                                 │                                            │
│                                 ▼                                            │
│                        IFusedObservation                                    │
│                                 │                                            │
│                                 ▼                                            │
│              ┌─────────────────────────────────────┐                        │
│              │         POMDP ENGINE                │                        │
│              │  ┌───────────────────────────────┐  │                        │
│              │  │  Bayesian Belief Update       │  │                        │
│              │  │  Thompson Sampling            │  │                        │
│              │  │  Safety Rules (9 правил)      │  │                        │
│              │  │  Trajectory Prediction        │  │                        │
│              │  └───────────────────────────────┘  │                        │
│              └─────────────────────────────────────┘                        │
│                                 │                                            │
│                                 ▼                                            │
│              ┌─────────────────────────────────────┐                        │
│              │            РЕЗУЛЬТАТ                │                        │
│              │  • Belief State (10 состояний)      │                        │
│              │  • Treatment Recommendation         │                        │
│              │  • Trajectory Prediction            │                        │
│              │  • Risk Assessment                  │                        │
│              └─────────────────────────────────────┘                        │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2.2 Модули системы

| Модуль | Файлы | Назначение |
|--------|-------|------------|
| **Trichology Core** | `TrichologyStates.ts`, `FolliCoreEngine.ts` | POMDP, состояния, действия |
| **Safety Rules** | `TrichologySafetyRules.ts` | Медицинские ограничения |
| **Vision** | `VisionTypes.ts`, `TrichoscopyAnalyzer.ts` | CV pipeline |
| **Acoustic** | `AcousticTypes.ts`, `AcousticAnalyzer.ts` | Audio pipeline |
| **Integration** | `MultimodalIntegration.ts` | Fusion + orchestration |

---

## 3. Vision Pipeline

### 3.1 Оборудование

**Совместимые устройства:**

| Устройство | Тип | Увеличение | Цена |
|------------|-----|------------|------|
| Dino-Lite Trichoscope | USB микроскоп | до 330x | $500-1,500 |
| TrikoScope | Смартфон-насадка | до 100x | $200-500 |
| FotoFinder | Профессиональный | до 200x | $10,000+ |
| Любой дерматоскоп | USB/камера | 10-100x | $100-500 |

**Требования к изображению:**
- Разрешение: минимум 640x480, рекомендуется 1920x1080
- Формат: JPEG, PNG
- Увеличение: 50-200x
- Освещение: поляризованное (предпочтительно)

### 3.2 Что анализируется

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         VISION ANALYSIS PIPELINE                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  INPUT: Трихоскопическое изображение                                        │
│         │                                                                    │
│         ▼                                                                    │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  STEP 1: FEATURE EXTRACTION (DINOv2-Large)                          │    │
│  │                                                                      │    │
│  │  Изображение ──▶ Vision Transformer ──▶ 1024-dim embedding          │    │
│  │                                                                      │    │
│  │  DINOv2 обучен на 142M изображений методом self-supervised          │    │
│  │  learning, что даёт +11% точности vs supervised на мед. данных      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│         │                                                                    │
│         ▼                                                                    │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  STEP 2: SEGMENTATION (MedSAM)                                      │    │
│  │                                                                      │    │
│  │  Embedding ──▶ Segment Anything ──▶ Маски волос и фолликулов        │    │
│  │                                                                      │    │
│  │  MedSAM обучен на 1.5M медицинских image-mask пар                   │    │
│  │  Режимы: automatic (grid) или interactive (point prompts)           │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│         │                                                                    │
│         ▼                                                                    │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  STEP 3: ANALYSIS HEADS                                             │    │
│  │                                                                      │    │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐     │    │
│  │  │   MORPHOMETRY   │  │    DENSITY      │  │     CYCLE       │     │    │
│  │  │                 │  │                 │  │                 │     │    │
│  │  │ • Bulb width    │  │ • Hair count    │  │ • Anagen %      │     │    │
│  │  │   (60-80 μm)    │  │   per cm²       │  │ • Telogen %     │     │    │
│  │  │                 │  │                 │  │ • Catagen %     │     │    │
│  │  │ • Shaft thick   │  │ • FU count      │  │                 │     │    │
│  │  │   (30-35 μm)    │  │ • FU distribut  │  │ • Vellus ratio  │     │    │
│  │  │                 │  │                 │  │ • Terminal ratio│     │    │
│  │  │ • Calibration   │  │ • Empty FU %    │  │                 │     │    │
│  │  │   (px → μm)     │  │                 │  │ • Miniaturized %│     │    │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────┘     │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│         │                                                                    │
│         ▼                                                                    │
│  OUTPUT: ITrichoscopyAnalysis                                               │
│  {                                                                           │
│    embedding: IImageEmbedding,      // 1024-dim vector                      │
│    morphometry: IMorphometryResult, // bulbWidth, shaftThickness            │
│    density: IDensityResult,         // hairCount, fuCount, distribution     │
│    cycle: ICycleAnalysis,           // anagenRatio, vellusTerminalRatio     │
│    segmentation: ISegmentationResult,                                       │
│    confidence: number,              // 0-1 overall confidence               │
│  }                                                                           │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.3 Референсные значения (PGMU Norms)

**Ширина луковицы (Bulb Width) по возрастам:**

| Возраст | Мужчины (parietal) | Женщины (parietal) |
|---------|--------------------|--------------------|
| 21-35 | 74.6 μm | 70.0 μm |
| 36-59 | 73.2 μm | 68.5 μm |
| 61-74 | 72.0 μm | 67.0 μm |
| 75-86 | 71.2 μm | 66.5 μm |

**Толщина стержня (Shaft Thickness):**

| Возраст | Мужчины (parietal) | Женщины (parietal) |
|---------|--------------------|--------------------|
| 21-35 | 33.8 μm | 30.0 μm |
| 36-59 | 32.8 μm | 29.0 μm |
| 61-74 | 32.0 μm | 28.0 μm |
| 75-86 | 31.8 μm | 27.5 μm |

---

## 4. Acoustic Pipeline

### 4.1 Оборудование

**Акустический сенсор FolliCore** (в разработке):

| Компонент | Модель | Назначение |
|-----------|--------|------------|
| Primary MEMS | IMP23ABSU | Основной сигнал (до 80kHz) |
| Contact Piezo | CM-01B | Контактные вибрации |
| Ambient | SPH0645LM4H | Компенсация шума |
| Processor | Raspberry Pi 5 | Edge inference |

**Параметры записи:**
- Sample rate: 48-192 kHz
- Bit depth: 16-24 bit
- Duration: 10 секунд на зону
- Channels: 3 (primary, contact, ambient)

### 4.2 Что анализируется

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        ACOUSTIC ANALYSIS PIPELINE                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  INPUT: Акустическая запись (IAcousticRecording)                            │
│         │                                                                    │
│         ▼                                                                    │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  STEP 1: PREPROCESSING                                              │    │
│  │                                                                      │    │
│  │  Raw signal ──▶ Noise reduction ──▶ Normalization ──▶ Clean signal  │    │
│  │                                                                      │    │
│  │  • Ambient channel subtraction                                       │    │
│  │  • Band-pass filtering (20Hz - 80kHz)                               │    │
│  │  • Motion artifact detection                                         │    │
│  │  • SNR calculation (target: >50 dB)                                 │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│         │                                                                    │
│         ▼                                                                    │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  STEP 2: FEATURE EXTRACTION (Wav2Vec2-Conformer)                    │    │
│  │                                                                      │    │
│  │  Clean signal ──▶ Wav2Vec2 ──▶ 768-dim embedding                    │    │
│  │                                                                      │    │
│  │  + Spectral features:                                                │    │
│  │    • Mel spectrogram (128 bins)                                     │    │
│  │    • MFCC (13 coefficients)                                         │    │
│  │    • Spectral centroid, rolloff, flatness                           │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│         │                                                                    │
│         ▼                                                                    │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  STEP 3: ANALYSIS HEADS                                             │    │
│  │                                                                      │    │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐     │    │
│  │  │    POROSITY     │  │   HYDRATION     │  │   STRUCTURE     │     │    │
│  │  │                 │  │                 │  │                 │     │    │
│  │  │ Измеряет:       │  │ Измеряет:       │  │ Классифицирует: │     │    │
│  │  │ • Acoustic      │  │ • Wave velocity │  │ • healthy       │     │    │
│  │  │   impedance     │  │ • Damping       │  │ • weathered     │     │    │
│  │  │ • Absorption    │  │   coefficient   │  │ • damaged       │     │    │
│  │  │   coefficient   │  │ • Moisture %    │  │                 │     │    │
│  │  │                 │  │                 │  │ Детектирует:    │     │    │
│  │  │ Score: 0-1      │  │ Score: 0-1      │  │ • Cuticle lift  │     │    │
│  │  │ (ниже=здоровее) │  │ (выше=здоровее) │  │ • Cortex damage │     │    │
│  │  │                 │  │                 │  │ • Split ends    │     │    │
│  │  │ Levels:         │  │ Levels:         │  │ • Chemical      │     │    │
│  │  │ • low (<0.3)    │  │ • dehydrated    │  │ • Heat damage   │     │    │
│  │  │ • normal        │  │ • suboptimal    │  │                 │     │    │
│  │  │ • high (>0.6)   │  │ • optimal       │  │ Damage score:   │     │    │
│  │  │                 │  │ • over-hydrated │  │ 0-1             │     │    │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────┘     │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│         │                                                                    │
│         ▼                                                                    │
│  OUTPUT: IAcousticAnalysisResult                                            │
│  {                                                                           │
│    embedding: IAudioEmbedding,      // 768-dim vector                       │
│    porosity: IPorosityAnalysis,     // score, level, absorption             │
│    hydration: IHydrationAnalysis,   // score, level, moisture%              │
│    structure: IStructuralAnalysis,  // class, damageScore, damageTypes      │
│    spectral: ISpectralFeatures,     // centroid, rolloff, mfcc              │
│    overallConfidence: number,       // 0-1                                  │
│  }                                                                           │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 4.3 Референсные значения (Acoustic Norms)

| Параметр | Здоровый | Weathered | Damaged |
|----------|----------|-----------|---------|
| Porosity | < 0.3 | 0.3 - 0.5 | > 0.5 |
| Hydration | > 0.7 | 0.5 - 0.7 | < 0.5 |
| Damping coef | < 0.3 | 0.3 - 0.5 | > 0.5 |
| Scattering regularity | > 0.8 | 0.6 - 0.8 | < 0.6 |

---

## 5. Multimodal Fusion

### 5.1 Стратегия объединения

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         LATE FUSION STRATEGY                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────────┐         ┌─────────────────────┐                   │
│  │  Vision Analysis    │         │  Acoustic Analysis  │                   │
│  │                     │         │                     │                   │
│  │  • density: 145     │         │  • porosity: 0.35   │                   │
│  │  • bulbWidth: 68    │         │  • hydration: 0.65  │                   │
│  │  • anagenRatio: 0.72│         │  • structure: weath │                   │
│  │  • vellusRatio: 0.22│         │  • damageScore: 0.3 │                   │
│  │  • confidence: 0.88 │         │  • confidence: 0.85 │                   │
│  └──────────┬──────────┘         └──────────┬──────────┘                   │
│             │                               │                               │
│             │      ┌─────────────────┐      │                               │
│             │      │  FUSION WEIGHTS │      │                               │
│             │      │                 │      │                               │
│             └─────▶│  Vision:  60%  │◀─────┘                               │
│                    │  Acoustic: 40%  │                                      │
│                    └────────┬────────┘                                      │
│                             │                                               │
│                             ▼                                               │
│              ┌─────────────────────────────┐                               │
│              │     FUSED OBSERVATION       │                               │
│              │                             │                               │
│              │  bulbWidth: weighted avg    │                               │
│              │  shaftThickness: weighted   │                               │
│              │  density: from vision       │                               │
│              │  anagenRatio: adjusted      │                               │
│              │  vellusRatio: adjusted      │                               │
│              │  porosity: from acoustic    │                               │
│              │  hydration: from acoustic   │                               │
│              │  confidence: combined       │                               │
│              └─────────────────────────────┘                               │
│                             │                                               │
│                             ▼                                               │
│              ┌─────────────────────────────┐                               │
│              │   MODALITY AGREEMENT        │                               │
│              │                             │                               │
│              │  structureAgreement: 0.85   │  ← Vision miniaturization     │
│              │  healthAgreement: 0.78      │    vs Acoustic damage         │
│              │  overallAgreement: 0.82     │                               │
│              │  discrepancies: [...]       │  ← Flags for review           │
│              └─────────────────────────────┘                               │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 5.2 Обнаружение расхождений

| Тип расхождения | Vision показывает | Acoustic показывает | Действие |
|-----------------|-------------------|---------------------|----------|
| Structure | Здоровая морфология | Повреждённая структура | Дополнительный осмотр |
| Health | Низкая плотность | Хорошая гидратация | Проверить освещение |
| Damage | Миниатюризация | Здоровая кутикула | Уточнить зону |

**Порог значимого расхождения:** > 0.3 разницы в нормализованных оценках

### 5.3 Зачем нужны обе модальности

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    COMPLEMENTARY ANALYSIS                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ПАРАМЕТР              VISION          ACOUSTIC         ВМЕСТЕ              │
│  ─────────────────────────────────────────────────────────────────────────  │
│                                                                              │
│  Плотность волос       ✅ Прямое        ❌ Нет            ✅                 │
│                        измерение                                            │
│                                                                              │
│  Толщина стержня       ✅ Прямое        ⚠️ Косвенно       ✅✅               │
│                        измерение       (резонанс)       (cross-check)       │
│                                                                              │
│  Пористость            ❌ Субъективно   ✅ Объективно     ✅                 │
│                        (визуально)     (импеданс)                           │
│                                                                              │
│  Гидратация            ❌ Не видно      ✅ Прямое         ✅                 │
│                                        измерение                            │
│                                                                              │
│  Фаза цикла            ✅ Anagen/       ⚠️ Косвенно       ✅                 │
│                        Telogen видны                                        │
│                                                                              │
│  Миниатюризация        ✅ Морфометрия   ⚠️ Косвенно       ✅✅               │
│                                        (структура)      (уверенность)       │
│                                                                              │
│  Воспаление            ✅ Визуально     ⚠️ Косвенно       ✅                 │
│                        (покраснение)                                        │
│                                                                              │
│  Химические            ⚠️ Иногда       ✅ Детектирует     ✅✅               │
│  повреждения           видны          повреждения                           │
│                                                                              │
│  Термические           ⚠️ Иногда       ✅ Детектирует     ✅✅               │
│  повреждения           видны          повреждения                           │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 6. POMDP Engine

### 6.1 Состояния фолликул (10 states)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         FOLLICLE STATES                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ЗДОРОВЫЕ СОСТОЯНИЯ                                                         │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐             │
│  │ HEALTHY_ANAGEN  │  │ HEALTHY_CATAGEN │  │ HEALTHY_TELOGEN │             │
│  │ Активный рост   │  │ Переходная фаза │  │ Фаза покоя      │             │
│  │ (85-90% волос)  │  │ (1-2% волос)    │  │ (10-15% волос)  │             │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘             │
│                                                                              │
│  ПАТОЛОГИЧЕСКИЕ СОСТОЯНИЯ                                                   │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐             │
│  │ EARLY_          │  │ ADVANCED_       │  │ STRESS_INDUCED  │             │
│  │ MINIATURIZATION │  │ MINIATURIZATION │  │ (Telogen        │             │
│  │ (Ранняя AGA)    │  │ (Продвинутая)   │  │  Effluvium)     │             │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘             │
│                                                                              │
│  ┌─────────────────┐  ┌─────────────────┐                                  │
│  │ INFLAMMATION    │  │ SENILE_ALOPECIA │                                  │
│  │ (Воспаление)    │  │ (Возрастная)    │                                  │
│  └─────────────────┘  └─────────────────┘                                  │
│                                                                              │
│  ТЕРМИНАЛЬНЫЕ СОСТОЯНИЯ                                                     │
│  ┌─────────────────┐  ┌─────────────────┐                                  │
│  │ DORMANT         │  │ TERMINAL        │                                  │
│  │ (Потенциально   │  │ (Необратимая    │                                  │
│  │  обратимо)      │  │  потеря)        │                                  │
│  └─────────────────┘  └─────────────────┘                                  │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 6.2 Действия (14 actions)

| Категория | Действия |
|-----------|----------|
| **Фармакологические** | Minoxidil 2%, Minoxidil 5%, Finasteride, Dutasteride |
| **Процедурные** | PRP, Мезотерапия, LLLT, Микронидлинг |
| **Лайфстайл** | Управление стрессом, Оптимизация питания, Улучшение сна |
| **Специальные** | Наблюдение, Направление к специалисту |

### 6.3 Belief Update (Bayesian)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         BAYESIAN BELIEF UPDATE                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  Prior Belief (до наблюдения):                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ HEALTHY_ANAGEN:        30%  ████████                                │   │
│  │ EARLY_MINIATURIZATION: 25%  ██████                                  │   │
│  │ STRESS_INDUCED:        20%  █████                                   │   │
│  │ HEALTHY_TELOGEN:       15%  ████                                    │   │
│  │ Другие:                10%  ███                                     │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
│                    + Observation (Fused)                                     │
│                    │                                                         │
│                    ▼                                                         │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  P(state | observation) ∝ P(observation | state) × P(state)         │   │
│  │                                                                      │   │
│  │  Likelihood учитывает:                                               │   │
│  │  • Морфометрию (bulb width, shaft thickness)                        │   │
│  │  • Плотность и cycle ratios                                         │   │
│  │  • Акустические метрики (porosity, hydration)                       │   │
│  │  • Контекст пациента (возраст, пол, генетика)                       │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
│                    │                                                         │
│                    ▼                                                         │
│                                                                              │
│  Posterior Belief (после наблюдения):                                       │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ EARLY_MINIATURIZATION: 62%  ████████████████                        │   │
│  │ STRESS_INDUCED:        18%  █████                                   │   │
│  │ HEALTHY_ANAGEN:        12%  ███                                     │   │
│  │ ADVANCED_MINIAT:        5%  █                                       │   │
│  │ Другие:                 3%  █                                       │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 6.4 Thompson Sampling для выбора лечения

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         THOMPSON SAMPLING                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  Для каждого действия поддерживается Beta-распределение:                    │
│  Beta(α = successes + 1, β = failures + 1)                                  │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  Action              α      β      E[θ]     Sample                  │   │
│  │  ─────────────────────────────────────────────────────────────────  │   │
│  │  Minoxidil 5%       45     12     0.79     0.82 ◀── Selected        │   │
│  │  PRP                28     15     0.65     0.71                     │   │
│  │  Мезотерапия        22     18     0.55     0.48                     │   │
│  │  Finasteride        35     20     0.64     0.59                     │   │
│  │  LLLT               15     10     0.60     0.65                     │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
│  Балансирует:                                                               │
│  • EXPLOITATION — выбор действий с высоким E[θ]                            │
│  • EXPLORATION — пробовать действия с высокой неопределённостью            │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 6.5 Safety Rules (9 правил)

| Тип | Правило | Действие |
|-----|---------|----------|
| **HARD** | NEVER_FINASTERIDE_FEMALE | Блокировать Finasteride для женщин |
| **HARD** | NEVER_IGNORE_INFLAMMATION | Блокировать стимуляцию при воспалении |
| **HARD** | CONTRAINDICATION_CHECK | Проверка противопоказаний |
| **SOFT** | AGE_APPROPRIATE_DOSAGE | Корректировка дозировки по возрасту |
| **SOFT** | PREGNANCY_CAUTION | Предупреждение при беременности |
| **ESCALATION** | SPECIALIST_REFERRAL | Направление при тяжёлых случаях |
| **ESCALATION** | PROGRESSION_ESCALATION | Алерт при >10% потере плотности |
| **ESCALATION** | RAPID_ONSET_ALERT | Алерт при быстром начале |
| **SOFT** | COMBINATION_LIMIT | Ограничение комбинаций |

---

## 7. User Journey

### 7.1 Первичный приём

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         СЦЕНАРИЙ: ПЕРВИЧНЫЙ ПРИЁМ                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ЭТАП 1: РЕГИСТРАЦИЯ ПАЦИЕНТА                                  [2 мин]      │
│  ════════════════════════════════════════════════════════════════════════   │
│                                                                              │
│  Специалист вводит данные:                                                  │
│  ┌────────────────────────────────────────────────────────────────────┐    │
│  │  Имя: Иван Петров                                                  │    │
│  │  Возраст: 42 года                                                  │    │
│  │  Пол: мужской                                                      │    │
│  │  Генетический риск: средний (отец с AGA)                          │    │
│  │  Хронический стресс: высокий (руководящая должность)              │    │
│  │  Медицинская история: гипертония (контролируемая)                 │    │
│  │  Текущие препараты: лизиноприл                                    │    │
│  └────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  Система инициализирует belief state с учётом контекста                     │
│                                                                              │
│  ──────────────────────────────────────────────────────────────────────────  │
│                                                                              │
│  ЭТАП 2: ВИЗУАЛЬНОЕ СКАНИРОВАНИЕ                               [5 мин]      │
│  ════════════════════════════════════════════════════════════════════════   │
│                                                                              │
│           Frontal ──────── Vertex                                           │
│              │                │                                              │
│         Temporal L ────── Temporal R                                        │
│                  \        /                                                  │
│                   Occipital                                                  │
│                                                                              │
│  Трихоскопом делаются снимки 5 зон (100x увеличение)                        │
│  Загружаются в систему: frontal.jpg, vertex.jpg, ...                        │
│                                                                              │
│  ──────────────────────────────────────────────────────────────────────────  │
│                                                                              │
│  ЭТАП 3: АКУСТИЧЕСКОЕ СКАНИРОВАНИЕ                             [5 мин]      │
│  ════════════════════════════════════════════════════════════════════════   │
│                                                                              │
│  Акустическим сенсором записываются те же 5 зон (по 10 сек)                 │
│  Сенсор прикладывается к каждой зоне, запись автоматическая                 │
│                                                                              │
│  ──────────────────────────────────────────────────────────────────────────  │
│                                                                              │
│  ЭТАП 4: АВТОМАТИЧЕСКИЙ АНАЛИЗ                                 [30 сек]     │
│  ════════════════════════════════════════════════════════════════════════   │
│                                                                              │
│  Система обрабатывает все данные:                                           │
│                                                                              │
│  ┌─ Зона: Frontal ─────────────────────────────────────────────────────┐   │
│  │  Vision:  density=142, bulb=67μm, anagen=68%, vellus=24%            │   │
│  │  Acoustic: porosity=0.38, hydration=0.62, structure=weathered       │   │
│  │  Agreement: 84%                                                      │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
│  ┌─ Зона: Vertex ──────────────────────────────────────────────────────┐   │
│  │  Vision:  density=128, bulb=64μm, anagen=62%, vellus=28%            │   │
│  │  Acoustic: porosity=0.42, hydration=0.58, structure=weathered       │   │
│  │  Agreement: 89%                                                      │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
│  ... (остальные зоны)                                                       │
│                                                                              │
│  ──────────────────────────────────────────────────────────────────────────  │
│                                                                              │
│  ЭТАП 5: РЕЗУЛЬТАТЫ                                            [3 мин]      │
│  ════════════════════════════════════════════════════════════════════════   │
│                                                                              │
│  ┌────────────────────────────────────────────────────────────────────┐    │
│  │                                                                    │    │
│  │  ДИАГНОЗ (Belief State):                                          │    │
│  │  ┌──────────────────────────────────────────────────────────────┐ │    │
│  │  │  EARLY_MINIATURIZATION    62%  ████████████████               │ │    │
│  │  │  STRESS_INDUCED           22%  ██████                         │ │    │
│  │  │  HEALTHY_ANAGEN           10%  ███                            │ │    │
│  │  │  Другие                    6%  ██                             │ │    │
│  │  └──────────────────────────────────────────────────────────────┘ │    │
│  │                                                                    │    │
│  │  РЕКОМЕНДАЦИИ:                                                    │    │
│  │  ┌──────────────────────────────────────────────────────────────┐ │    │
│  │  │  PRIMARY: Миноксидил 5% топически                            │ │    │
│  │  │           Confidence: 82%                                     │ │    │
│  │  │                                                               │ │    │
│  │  │  ALTERNATIVE: PRP-терапия (курс 4 процедуры)                  │ │    │
│  │  │               Confidence: 71%                                 │ │    │
│  │  │                                                               │ │    │
│  │  │  LIFESTYLE: Управление стрессом (рекомендовано)              │ │    │
│  │  └──────────────────────────────────────────────────────────────┘ │    │
│  │                                                                    │    │
│  │  ПРОГНОЗ (без лечения):                                           │    │
│  │  ┌──────────────────────────────────────────────────────────────┐ │    │
│  │  │  Текущая плотность (vertex): 128 волос/см²                   │ │    │
│  │  │  Через 6 месяцев: ~118 волос/см² (-8%)                       │ │    │
│  │  │  Через 12 месяцев: ~105 волос/см² (-18%)                     │ │    │
│  │  │  Тренд: declining                                             │ │    │
│  │  │  Уверенность прогноза: 75%                                   │ │    │
│  │  └──────────────────────────────────────────────────────────────┘ │    │
│  │                                                                    │    │
│  │  ⚠️ ALERTS:                                                        │    │
│  │  • Умеренный риск прогрессии (progression_risk: 0.65)            │    │
│  │  • Высокий уровень стресса — рассмотреть комплексный подход      │    │
│  │                                                                    │    │
│  └────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  ОБЩЕЕ ВРЕМЯ: ~15 минут                                                     │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 7.2 Повторный приём (мониторинг)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         СЦЕНАРИЙ: ПОВТОРНЫЙ ПРИЁМ (через 3 месяца)           │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  Система загружает историю пациента:                                        │
│  • Предыдущий belief state                                                  │
│  • Назначенное лечение: Миноксидил 5%                                       │
│  • Все предыдущие измерения                                                 │
│                                                                              │
│  После нового сканирования:                                                 │
│                                                                              │
│  ┌────────────────────────────────────────────────────────────────────┐    │
│  │  СРАВНЕНИЕ С ПРЕДЫДУЩИМ ВИЗИТОМ                                    │    │
│  │                                                                    │    │
│  │  Параметр              Было        Стало       Изменение          │    │
│  │  ──────────────────────────────────────────────────────────────   │    │
│  │  Плотность (vertex)    128         135         +5.5% ✅           │    │
│  │  Anagen ratio          62%         68%         +6%   ✅           │    │
│  │  Vellus ratio          28%         24%         -4%   ✅           │    │
│  │  Porosity              0.42        0.35        -17%  ✅           │    │
│  │  Hydration             0.58        0.68        +17%  ✅           │    │
│  │                                                                    │    │
│  │  ВЫВОД: Положительная динамика, лечение эффективно               │    │
│  └────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  Система обновляет:                                                         │
│  • Belief state (смещение в сторону HEALTHY)                               │
│  • Thompson Sampling arms (α++ для Миноксидил 5%)                          │
│                                                                              │
│  Рекомендация: Продолжить текущее лечение, следующий визит через 3 мес     │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 8. Код: Пример интеграции

### 8.1 Полный pipeline

```typescript
import {
  createMultimodalIntegration,
  IMultimodalInput,
  IPatientContext,
} from '@follicore/platform';

// 1. Создание интеграции
const integration = createMultimodalIntegration({
  visionWeight: 0.6,
  acousticWeight: 0.4,
  autoUpdateBelief: true,
  includeModalityComparison: true,
});

// 2. Инициализация с ML backends
await integration.initialize({
  vision: {
    featureExtractor: dinov2Backend,
    segmentation: medsamBackend,
    morphometryHead: morphometryModel,
    densityHead: densityModel,
    cycleHead: cycleModel,
  },
  acoustic: {
    preprocessor: audioPreprocessor,
    featureExtractor: wav2vec2Backend,
    spectralBackend: spectralAnalyzer,
    hairAnalysisBackend: acousticHeads,
    vectorDb: similarityDatabase,
  },
});

// 3. Регистрация пациента
const patientContext: IPatientContext = {
  age: 42,
  gender: 'male',
  geneticRisk: 0.5,
  chronicStressLevel: 'high',
  medicalHistory: ['hypertension'],
  currentTreatments: ['lisinopril'],
};

integration.initializePatient('patient_001', patientContext);

// 4. Анализ одной зоны
const input: IMultimodalInput = {
  image: frontalImage,      // ITrichoscopyImage
  recording: frontalAudio,  // IAcousticRecording
  zone: 'frontal',
};

const result = await integration.runPipeline(
  'patient_001',
  input,
  patientContext
);

// 5. Результаты
console.log('Fused Observation:', result.fusedObservation);
console.log('Vision Analysis:', result.visionAnalysis);
console.log('Acoustic Analysis:', result.acousticAnalysis);
console.log('Modality Agreement:', result.modalityAgreement);
console.log('Belief State:', result.beliefState);
console.log('Recommendation:', result.recommendation);

// 6. Scalp Mapping (все 5 зон)
const scalpInputs: IMultimodalInput[] = [
  { image: frontalImg, recording: frontalRec, zone: 'frontal' },
  { image: vertexImg, recording: vertexRec, zone: 'vertex' },
  { image: temporalLImg, recording: temporalLRec, zone: 'temporal' },
  { image: temporalRImg, recording: temporalRRec, zone: 'temporal' },
  { image: occipitalImg, recording: occipitalRec, zone: 'occipital' },
];

const scalpResult = await integration.runScalpMapping(
  'patient_001',
  scalpInputs,
  patientContext
);

console.log('Scalp Summary:', scalpResult.scalpSummary);
console.log('Final Recommendation:', scalpResult.finalRecommendation);
console.log('Trajectory:', scalpResult.trajectoryPrediction);
```

### 8.2 Обработка результатов

```typescript
// Belief State
const beliefState = result.beliefState;
const topState = [...beliefState.stateDistribution.entries()]
  .sort((a, b) => b[1] - a[1])[0];

console.log(`Most likely state: ${topState[0]} (${(topState[1] * 100).toFixed(1)}%)`);

// Recommendation
const rec = result.recommendation;
console.log(`Primary: ${rec.primaryAction} (confidence: ${rec.confidence})`);
console.log(`Alternatives: ${rec.alternatives.map(a => a.action).join(', ')}`);

if (rec.safetyAlerts.length > 0) {
  console.warn('Safety Alerts:', rec.safetyAlerts);
}

// Modality Agreement
const agreement = result.modalityAgreement;
if (agreement.overallAgreement < 0.7) {
  console.warn('Low modality agreement - consider additional examination');
  console.warn('Discrepancies:', agreement.discrepancies);
}

// Trajectory
const trajectory = integration.predictTrajectory('patient_001', 12);
console.log(`12-month prediction: ${trajectory.trend}`);
console.log(`Expected density change: ${trajectory.expectedDensityChange}%`);
```

---

## 9. Глоссарий

| Термин | Определение |
|--------|-------------|
| **POMDP** | Partially Observable Markov Decision Process — модель принятия решений с неполной информацией |
| **Belief State** | Распределение вероятностей по возможным состояниям |
| **Thompson Sampling** | Алгоритм балансировки exploration/exploitation |
| **Late Fusion** | Объединение модальностей на уровне решений, не признаков |
| **Anagen** | Фаза активного роста волоса (2-7 лет) |
| **Telogen** | Фаза покоя волоса (2-3 месяца) |
| **Vellus** | Пушковые (тонкие, непигментированные) волосы |
| **Terminal** | Терминальные (толстые, пигментированные) волосы |
| **Miniaturization** | Процесс превращения терминальных волос в пушковые |
| **AGA** | Androgenetic Alopecia — андрогенетическая алопеция |
| **FU** | Follicular Unit — фолликулярная единица (1-4 волоса) |

---

**Версия документа:** 1.0
**Дата:** 2026-01-17
**Автор:** FolliCore Team

---

**© 2026 Благотворительный фонд "Другой путь"**
**FolliCore | awfond.ru**
